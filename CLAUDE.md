# CLAUDE.md - 台北都市韌性規劃平台 Taipei Lens 開發指南

## 專案總覽

台北都市韌性規劃平台 Taipei Lens 是一個以都市規劃者為中心、以「行動導向」為設計哲學的互動式決策支援工具。平台旨在打破傳統風險評估的數據壁壘，將都市規劃師的工作流程——特別是**都市更新**中的**「整建」**與**「重建」**決策——直接融入產品核心。

### 核心目標
- 賦予規劃師能力，使其可以**自定義風險評估模型**
- 動態模擬不同政策優先級下的情境
- 在地圖上直觀地識別出最需要投入資源的「超級熱區」
- 制定更具科學依據、更公平、更具韌性的都市發展策略

## 問題陳述

台北市都市更新面臨三大相互交織的嚴峻挑戰：

1. **結構安全風險**：大量依循舊有抗震規範興建的老舊建築，在未來強震中構成嚴重威脅
2. **氣候變遷風險**：盆地地形使都市熱島效應尤為顯著，極端高溫事件頻率增加
3. **社會脆弱性風險**：人口高齡化、獨居長者比例攀升以及貧富差距，使特定脆弱群體在災害來臨時缺乏足夠應變能力

規劃者極度缺乏一個能整合上述挑戰的決策工具，需要能**主動定義、量化、並模擬**在不同政策側重下都市更新急迫性的動態平台。

## 目標使用者

**核心使用者：** 台北市政府都市發展局、都市更新處、防災應變單位的規劃師與政策制定者

**使用者需求：**
- 建立自己的評估模型：透過調整不同風險因子的權重，來反映當前的政策方向
- 一鍵生成優先級地圖：輸入模型參數後，能立即在地圖上看到結果，並能調整閥值篩選出最關鍵的區域
- 匯出視覺化報告：將分析結果（地圖、公式、選定區域列表）作為會議報告的有力佐證

## 核心功能需求

### 1. 互動式 3D 地圖儀表板

- **地圖基底**：採用高解析度的台北市 3D 建築地圖
- **地圖互動**：提供流暢的平移 (Pan)、縮放 (Zoom) 與旋轉視角 (Rotate/Pitch)
- **資訊探查**：滑鼠懸停在任一「最小統計區域」或建築物上時，彈出視窗顯示其基礎屬性資訊
  - **基礎資訊顯示**：建築物的基本屬性（面積、樓高等）
  - **Fragility Curve 視覺化**：在基礎資訊下方顯示小型的 Fragility Curve（易損性曲線）二維圖表
    - 橫軸 (X軸)：地震規模 (Magnitude) 或地震加速度 (PGA)
    - 縱軸 (Y軸)：損失程度 (Damage Probability)，範圍從 0 到 1
    - 曲線類型：該建築物在不同地震強度下的預期損壞機率曲線
    - 圖表尺寸：小型嵌入式圖表（寬度 180-220px，高度 120-150px）

### 2. 規劃師工具箱 (Planner's Toolbox)

位於介面左側的懸浮式、可收合側邊欄，採用手風琴式選單結構，分為三大可獨立展開/收合的區塊：

#### 2.1 原始數據圖層 (Data Layers)

- **功能**：提供基礎數據的視覺化開關，供規劃師進行初步的環境探查
- **UI 元件**：一系列帶有單選按鈕 (Radio Button) 的圖層列表
- **互斥顯示**：一次只能勾選一個圖層，避免視覺混亂。再次點擊已選中的圖層可以取消選擇
- **包含圖層**：地表溫度、綠覆率、建築屋齡、人口密度、社會脆弱性指標等

#### 2.2 整建分析模組 (Renovation Analysis Module)

專注於現有都市結構的改善與補強，旨在幫助規劃師決定「錢要花在哪個刀口上」。

**子模組 2.2.1：道路綠化優先級分析**
- **目標**：識別最需要透過植樹進行降溫及環境改善的區域
- **互動式公式**：`優先級分數 = ( 因子A × 權重A ) + ( 因子B × 權重B ) + ...`
- **可調因子與權重**：
  - `地表溫度`：權重預設 0.4
  - `(1 - 綠覆率)`：權重預設 0.3
  - `人口密度`：權重預設 0.3
- **權重約束**：所有權重數值的總和必須等於 1
- **閥值設定**：`高亮分數 >=` [數值輸入框]，範圍 0-1，預設 0.8
- **科學方法提示 (`?`)**：解釋為何選擇這些因子

**子模組 2.2.2：建築耐震補強優先級分析**
- **目標**：識別地震損壞風險最高，最需優先進行結構補強的區域
- **可調因子與權重**：
  - `建築平均屋齡`：權重預設 0.5
  - `結構脆弱度`：權重預設 0.3
  - `土壤液化潛勢`：權重預設 0.2
- **閥值設定**：範圍 0-1，預設 0.75

#### 2.3 重建分析模組 (Reconstruction Analysis Module)

著眼於大規模的都市更新與空間再造，輔助規劃師進行更宏觀的區域規劃。

**子模組 2.3.1：公園新闢選址潛力分析**
- **目標**：找出最缺乏公園綠地且潛在需求最高的區域
- **可調因子與權重**：
  - `(1 - 綠地服務涵蓋率)`：權重預設 0.5
  - `人口密度`：權重預設 0.3
  - `社會脆弱性指標`：權重預設 0.2
- **閥值設定**：範圍 0-1，預設 0.8

**子模組 2.3.2：都市更新急迫性分析**
- **目標**：綜合評估多重風險，識別最需進行大規模重建的核心區域
- **可調因子與權重**：
  - `地震綜合風險`：權重預設 0.4（可參考「建築耐震補強」模組的分析結果）
  - `都市熱島衝擊`：權重預設 0.3
  - `(1 - 土地利用效率)`：權重預設 0.3
- **閥值設定**：範圍 0-1，預設 0.85

### 核心分析流程

所有子模組均遵循以下流程：

1. **參數設定**：使用者透過「互動式公式」設定各因子的權重，並透過「數值輸入框」設定觸發高亮的閥值
2. **觸發運算**：使用者點擊模組下方的 **[執行分析]** 按鈕
3. **結果呈現**：系統在後端進行計算，完成後在地圖上高亮顯示所有綜合分數**大於等於**設定閥值的「最小統計區域」
4. **結果重置**：提供 **[清除結果]** 按鈕，用以清除地圖上的高亮圖層

## 資料處理

### 核心分析單元
所有分析與視覺化均基於統一的地理網格——**「最小統計區域」**。所有原始數據皆預處理並彙整至此單元。

### 資料標準化
在進行任何加權計算前，所有因子的原始數據均採用**「最大-最小標準化法 (Min-Max Normalization)」**，將其數值縮放至 0 到 1 的區間內。

### 資料來源
- **NASA 數據**：ECOSTRESS/Landsat 地表溫度 (LST)
- **在地數據**：
  - 台北市政府開放平台（建築使用執照、綠地圖資）
  - 內政部戶政司（人口統計）
  - 國家災害防救科技中心（土壤液化圖資）

## 技術架構

### 前端技術
- **框架**：React.js
- **地圖函式庫**：Mapbox GL JS

### 後端技術
- **後端框架**：FastAPI (Python) - 用於處理數據API與複雜計算

### 資料處理
- **工具**：GeoPandas、Python
- **格式**：GeoJSON 或 Vector Tiles
- **座標系統**：EPSG:4326 (WGS84)

### 前端風格
- 風格以淺色系為主，要簡約乾淨

## Claude Code 注意事項
- 寫 python 程式碼的時候，要特別注意編碼，因為我的程式碼會有中文相關的註解，請確保使用的編碼可以處理中文。
- 請在每次更動前端之後用 playwright MCP 打開瀏覽器來檢查功能是否正常，除非我特別指定不要用 playwirght，不然都請你用 playwright MCP 檢查。
- 前端我已經部署在 http://localhost:10000/，請你不要自己部署前端。
- 後端我已經部署在 http://0.0.0.0:8000。請你不要自己部署後端。
